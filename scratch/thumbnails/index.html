<!DOCTYPE HTML>
<html>
  <head>
    <title>all thumbnails</title>
    <style>
      .thumb-wrap {
        display: inline-block;
        margin: 10px;
        vertical-align: top;
        text-align: center;
        width: 180px;
      }
      img {
        width: 180px;
        height: auto;
        display: block;
        margin: 0 auto 8px auto;
      }
      body {
        text-align: center;
      }
      .thumb-title {
        font-size: 15px;
        color: #222;
        min-height: 1.6em;
        text-decoration: none;
        display: block;
      }
      .thumb-title:hover {
        text-decoration: underline;
        color: #0d72cf;
      }
      .more-btn-wrap {
        display: block;
        margin-top: 16px;
      }
    </style>
  </head>
  <body>
    <div id="thumbs-container"></div>
    <div class="more-btn-wrap" id="more-btn-area"></div>
    <script>
      let count = 0;
      const thumbsPerLoad = 4 * 5;
      const thumbsEachRow = 5;

      async function createThumbDiv(id) {
        const div = document.createElement('div');
        div.className = 'thumb-wrap';

        const img = document.createElement('img');
        img.src = `https://uploads.scratch.mit.edu/get_image/project/${id}_307x246.png`;
        div.appendChild(img);

        // タイトルリンク（aタグ）
        const titleLink = document.createElement('a');
        titleLink.className = 'thumb-title';
        titleLink.href = `https://scratch.mit.edu/projects/${id}/`;
        titleLink.target = "_blank";  // 新しいタブで開く
        titleLink.textContent = '...';
        div.appendChild(titleLink);

        try {
          const res = await fetch(`https://corsproxy.io/?url=https://api.scratch.mit.edu/projects/${id}/`);
          if (!res.ok) {
            if (res.status === 404) {
              titleLink.textContent = "<非共有>";
            } else {
              titleLink.textContent = "<取得失敗>";
            }
            return div;
          }
          const data = await res.json();
          if (typeof data.title === "string") {
            titleLink.textContent = data.title;
          } else {
            titleLink.textContent = "<取得失敗>";
          }
        } catch (e) {
          titleLink.textContent = "<取得失敗>";
        }
        return div;
      }

      // サムネイル群を追加表示
      async function addThumbnails() {
        const thumbsContainer = document.getElementById("thumbs-container");
        for (let row = 0; row < 4; row++) {
          for (let i = 1; i <= thumbsEachRow; i++) {
            const id = count * thumbsPerLoad + row * thumbsEachRow + i;
            const thumbDiv = await createThumbDiv(id);
            thumbsContainer.appendChild(thumbDiv);
          }
          thumbsContainer.appendChild(document.createElement("br"));
        }
        count += 1;
      }

      // ボタン生成（常に一番下）
      function createButton() {
        const btnArea = document.getElementById("more-btn-area");
        btnArea.innerHTML = ''; // 前のボタン消す
        const button = document.createElement("button");
        button.textContent = "もっと見る";
        button.onclick = async function() {
          button.disabled = true;
          await addThumbnails();
          createButton(); // 再生成（最下部維持）
        };
        btnArea.appendChild(button);
      }

      // 初回読み込み
      (async()=>{
        await addThumbnails();
        createButton();
      })();
    </script>
  </body>
</html>
