<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイクラアドオン生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <h1>マイクラアドオン生成</h1>

    <form id="data-form">
        <label for="name">名前:</label>
        <input type="text" id="name" required><br><br>

        <label for="english-name">英語のパックの名前:</label>
        <input type="text" id="english-name" required><br><br>

        <label for="description">説明:</label>
        <input type="text" id="description" required><br><br>

        <div id="items-container">
            <div class="item-entry">
                <label for="item-name">アイテムの名前:</label>
                <input type="text" class="item-name" required><br><br>

                <label for="item-english-name">英語のアイテムの名前:</label>
                <input type="text" class="item-english-name" required><br><br>

                <label for="item-image">アイテムの画像(サイズは16の倍数の正方形):</label>
                <input type="file" class="item-image" required><br><br>

                <label for="allow_off_hand">左手に持てるか:</label>
                <input type="checkbox" class="allow_off_hand" value="True"><br><br>

                <label for="bundle_interaction">バンドルにした時の容量(1〜64):</label>
                <input type="number" class="bundle_interaction" min="1" max="64" value="1" required><br><br>

                <label for="can_destroy_in_creative">クリエイティブでブロックを叩いた時に壊せるか:</label>
                <input type="checkbox" class="can_destroy_in_creative" value="True"><br><br>

                <label for="damage">与えるダメージ:</label>
                <input type="number" class="damage" min="1" value="1" required><br><br>

                <label for="food">食べ物になるか:</label>
                <input type="checkbox" class="food" value="True"><br><br>

                <div id="foods">
                    <label for="can_always_eat">満腹でも食べられるか:</label>
                    <input type="checkbox" class="can_always_eat" value="True"><br><br>

                    <label for="bundle_interaction">回復する満腹度(1~4294967295?):</label>
                    <input type="number" class="bundle_interaction" min="1" max="4294967295" value="1"><br><br>
                </div>
            </div>
        </div>
        
        <button type="button" id="add-item">アイテムを追加</button><br><br>
        <button type="button" id="create-mcaddon">MCAddon作成</button>
    </form>

    <a id="download-link" href="#" style="display:none;">ここをクリックしてダウンロード</a>

    <script>
        window.addEventListener("load", (event) => {
            while (true) {
                const itemEntries = document.querySelectorAll('.item-entry');
                for (const entry of itemEntries) {
                    const food = entry.querySelector('.food').value;
                    if (entry.querySelector('.food').value=="True") {
                        const food = true;
                    } else {
                        const food = false;
                    }
                    const element_foods = document.getElementById('foods');
                    if (food) {
                        elements_foods.style.display = "block";
                    } else {
                        elements_foods.style.display = "none";
                    }
                }
            }
        });
        
        // UUID生成関数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // アイテムのエントリを追加する関数
        document.getElementById('add-item').addEventListener('click', function() {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'item-entry';
            itemContainer.innerHTML = `
                <label for="item-name">アイテムの名前:</label>
                <input type="text" class="item-name" required><br><br>

                <label for="item-english-name">英語のアイテムの名前:</label>
                <input type="text" class="item-english-name" required><br><br>

                <label for="item-image">アイテムの画像(サイズは16の倍数の正方形):</label>
                <input type="file" class="item-image" required><br><br>

                <label for="allow_off_hand">左手に持てるか:</label>
                <input type="checkbox" class="allow_off_hand" value="True"><br><br>

                <label for="bundle_interaction">バンドルにした時の容量(1〜64):</label>
                <input type="number" class="bundle_interaction" min="1" max="64" value="1" required><br><br>

                <label for="can_destroy_in_creative">クリエイティブでブロックを叩いた時に壊せるか:</label>
                <input type="checkbox" class="can_destroy_in_creative" value="True"><br><br>

                <label for="damage">与えるダメージ:</label>
                <input type="number" class="damage" min="1" value="1" required><br><br>

                <button type="button" class="remove-item">削除</button><br><br>
            `;
            document.getElementById('items-container').appendChild(itemContainer);

            // 削除ボタンにイベントリスナーを追加
            itemContainer.querySelector('.remove-item').addEventListener('click', function() {
                itemContainer.remove();
            });
        });

        document.getElementById('create-mcaddon').addEventListener('click', async function () {
            // 入力データを取得
            const name = document.getElementById('name').value;
            const englishName = document.getElementById('english-name').value;
            const description = document.getElementById('description').value;

            // UUIDを生成
            const UUIDA = generateUUID();
            const UUIDB = generateUUID();
            const UUIDC = generateUUID();
            const UUIDD = generateUUID();

            // RP ZIPファイルの生成
            const rpZip = new JSZip();
            const rp = rpZip.folder("RP");
            rp.file("manifest.json", JSON.stringify({
                "format_version": 1,
                "header": {
                    "description": description,
                    "name": name,
                    "uuid": UUIDA,
                    "version": [1, 0, 0],
                    "min_engine_version": [1, 12, 0]
                },
                "modules": [
                    {
                        "description": description,
                        "type": "resources",
                        "uuid": UUIDB,
                        "version": [1, 0, 0]
                    }
                ],
                "dependencies": [
                    {
                        "uuid": UUIDC,
                        "version": [1, 0, 0]
                    }
                ]
            }, null, 2));
            const rpTextures = rp.folder("textures");
            const texturesItems = rpTextures.folder("items");

            // BP ZIPファイルの生成
            const bpZip = new JSZip();
            const bp = bpZip.folder("BP");
            bp.file("manifest.json", JSON.stringify({
                "format_version": 1,
                "header": {
                    "description": description,
                    "name": name,
                    "uuid": UUIDC,
                    "version": [1, 0, 0],
                    "min_engine_version": [1, 12, 0]
                },
                "modules": [
                    {
                        "description": description,
                        "type": "data",
                        "uuid": UUIDD,
                        "version": [1, 0, 0]
                    }
                ],
                "dependencies": [
                    {
                        "uuid": UUIDA,
                        "version": [1, 0, 0]
                    }
                ]
            }, null, 2));
            const bpItems = bp.folder("items");

            // 各アイテムの情報を処理
            const itemEntries = document.querySelectorAll('.item-entry');
            const itemTexturesData = {};
            for (const entry of itemEntries) {
                const itemName = entry.querySelector('.item-name').value;
                const itemEnglishName = entry.querySelector('.item-english-name').value;
                const itemImageFile = entry.querySelector('.item-image').files[0];
                if (entry.querySelector('.allow_off_hand').value=="True") {
                    const allow_off_hand = true;
                } else {
                    const allow_off_hand = false;
                }
                const bundle_interaction = entry.querySelector('.bundle_interaction').value;
                if (bundle_interaction > 64) {
                    alert("64より小さい値にしてください");
                }
                const can_destroy_in_creative = entry.querySelector('.can_destroy_in_creative').value;
                if (entry.querySelector('.can_destroy_in_creative').value=="True") {
                    const can_destroy_in_creative = true;
                } else {
                    const can_destroy_in_creative = false;
                }
                const damage = entry.querySelector('.damage').value;
                const food = entry.querySelector('.food').value;
                if (entry.querySelector('.food').value=="True") {
                    const food = true;
                } else {
                    const food = false;
                }
                if (food==true) {
                    const can_always_eat = entry.querySelector('.can_always_eat').value;
                    const nutrition = entry.querySelector('.nutrition').value;
                    const foods = JSON.stringify(
                        {
                            "can_always_eat": can_always_eat,
                            "nutrition": nutrition
                        });
                } else {
                    const foods = null;
                }

                texturesItems.file(`${itemEnglishName}.png`, await itemImageFile.arrayBuffer());
                itemTexturesData[itemEnglishName] = {
                    "textures": `textures/items/${itemEnglishName}`
                };

                bpItems.file(`${itemEnglishName}.json`, JSON.stringify({
                    "format_version": "1.21.10",
                    "minecraft:item": {
                        "description": {
                            "identifier": `${englishName}:${itemEnglishName}`,
                            "menu_category": {
                                "category": "construction"
                            }
                        },
                        "components": {
                            "minecraft:max_stack_size": 64,
                            "minecraft:icon": itemEnglishName,
                            "minecraft:display_name": {
                                "value": itemName
                            },
                            "minecraft:allow_off_hand": {
                                "value": allow_off_hand
                            },
                            "minecraft:bundle_interaction": {
                                "num_viewable_slots": bundle_interaction
                            },
                            "minecraft:can_destroy_in_creative": {
                                "value": can_destroy_in_creative
                            },
                            "minecraft:damage": {
                                "value": damage
                            }
                            foods
                        }
                    }
                }, null, 2));
            }

            // アイテムテクスチャJSONファイルを追加
            rpTextures.file("item_texture.json", JSON.stringify({
                "resource_pack_name": englishName,
                "texture_name": "atlas.items",
                "texture_data": itemTexturesData
            }, null, 2));

            // RP MCPACKファイルを生成
            const rpZipBlob = await rpZip.generateAsync({ type: "blob" });
            const rpMcpack = new File([rpZipBlob], `${name}_RP.mcpack`, { type: "application/zip" });

            // BP MCPACKファイルを生成
            const bpZipBlob = await bpZip.generateAsync({ type: "blob" });
            const bpMcpack = new File([bpZipBlob], `${name}_BP.mcpack`, { type: "application/zip" });

            // MCAddon ZIPファイルの生成
            const mcaddonZip = new JSZip();
            mcaddonZip.file(rpMcpack.name, rpMcpack);
            mcaddonZip.file(bpMcpack.name, bpMcpack);

            const mcaddonBlob = await mcaddonZip.generateAsync({ type: "blob" });

            // ダウンロードリンクを設定
            const downloadLink = document.getElementById('download-link');
            // BlobをオブジェクトURLとして作成
            const mcaddonUrl = URL.createObjectURL(mcaddonBlob);
            downloadLink.href = mcaddonUrl;
            downloadLink.download = `${name}.mcaddon`; // ここで拡張子を.mcaddonに設定
            downloadLink.style.display = 'block';

            // ダウンロード完了後、オブジェクトURLを解放
            downloadLink.addEventListener('click', function () {
                setTimeout(() => URL.revokeObjectURL(mcaddonUrl), 100);
            });
        });
    </script>
</body>
</html>
