<!DOCTYPE html>
<html>
  <head>
    <title>暗記読み込み (Memory Load)</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background-color: #f4f4f9;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #0056b3;
      }
      .controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }
      input[type="file"] {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      input[type="submit"] {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      input[type="submit"]:hover {
        background-color: #0056b3;
      }
      #quiz-area {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 20px;
      }
      .question-box {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 1.2em;
        line-height: 1.5;
      }
      .answers {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .answer-button {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
      }
      .answer-button:hover {
        background-color: #e2e6ea;
      }
      .correct {
        background-color: #28a745;
        color: white;
      }
      .incorrect {
        background-color: #dc3545;
        color: white;
      }
      .message {
        margin-top: 10px;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>暗記読み込み (Memory Load)</h1>
      <div class="controls">
        <input type="file" id="inputJSON" accept="application/json" multiple />
        <input type="submit" id="submit" value="ファイル読み込み & 出題開始" />
      </div>
      <div id="quiz-area">
        <div id="logs" class="logs-container"></div>
        <div id="question-area"></div>
      </div>
    </div>

    <script>
      let quizData = [];
      let currentQuestionIndex = 0;

      document.getElementById("submit").addEventListener("click", function() {
        const fileInput = document.getElementById("inputJSON");
        const files = fileInput.files;
        const logsDiv = document.getElementById("logs");
        logsDiv.innerHTML = "";
        
        if (files.length === 0) {
          logsDiv.innerHTML = '<div class="log-entry error">ファイルが選択されていません。 (No files selected.)</div>';
          return;
        }

        let completed = 0;
        let tempQuizData = [];

        for (const file of files) {
          const reader = new FileReader();

          reader.onload = (event) => {
            try {
              const content = event.target.result;
              const jsonObject = JSON.parse(content);
              tempQuizData = tempQuizData.concat(jsonObject);
            } catch (error) {
              console.error(`❌ ファイル "${file.name}" の解析に失敗しました: ${error.message}`);
              logsDiv.innerHTML += `<div class="log-entry error">❌ ファイル "${file.name}" の解析に失敗しました。</div>`;
            } finally {
              completed++;
              if (completed === files.length) {
                // 問題の配列をシャッフル
                const allQuestions = tempQuizData.sort(() => Math.random() - 0.5);
                
                // 各問題の選択肢をシャッフル
                quizData = allQuestions.map(question => {
                  const answers = question.answer;
                  const originalCorrectAnswer = answers[question.seikai];
                  
                  // 選択肢をシャッフル
                  const shuffledAnswers = answers.sort(() => Math.random() - 0.5);
                  
                  // シャッフル後の正解の新しいインデックスを特定
                  const newCorrectIndex = shuffledAnswers.indexOf(originalCorrectAnswer);
                  
                  return {
                    ...question,
                    answer: shuffledAnswers,
                    seikai: newCorrectIndex
                  };
                });
                
                currentQuestionIndex = 0;
                displayQuestion();
                console.log("すべてのファイルを読み込み、問題と選択肢をシャッフルしました。", quizData);
              }
            }
          };

          reader.onerror = () => {
            console.error(`❌ ファイル "${file.name}" の読み込み中にエラーが発生しました。`);
            logsDiv.innerHTML += `<div class="log-entry error">❌ ファイル "${file.name}" の読み込み中にエラーが発生しました。</div>`;
            completed++;
          };

          reader.readAsText(file);
        }
      });
      
      function displayQuestion() {
        const questionArea = document.getElementById("question-area");
        questionArea.innerHTML = "";
        
        if (currentQuestionIndex >= quizData.length) {
          questionArea.innerHTML = "<h2>クイズ終了！</h2><p>すべての問題を完了しました。</p>";
          return;
        }
        
        const currentQuestion = quizData[currentQuestionIndex];
        
        const questionHtml = `
          <div class="question-box">${currentQuestion.question}</div>
          <div class="answers">
            ${currentQuestion.answer.map((ans, index) => `
              <button class="answer-button" data-index="${index}">${ans}</button>
            `).join('')}
          </div>
          <div class="message"></div>
        `;
        
        questionArea.innerHTML = questionHtml;
        
        document.querySelectorAll('.answer-button').forEach(button => {
          button.addEventListener('click', checkAnswer);
        });
      }

      function checkAnswer(event) {
          // `parseInt()`を使って文字列を数値に変換する
         const selectedIndex = parseInt(event.target.getAttribute('data-index'));
         const currentQuestion = quizData[currentQuestionIndex];
         const messageDiv = document.querySelector('.message');

          document.querySelectorAll('.answer-button').forEach(button => {
            button.disabled = true;
          });

        if (selectedIndex === parseInt(currentQuestion.seikai)) {
          event.target.classList.add('correct');
          messageDiv.textContent = '正解です！';
        } else {
          event.target.classList.add('incorrect');
          messageDiv.textContent = '不正解です。';
          document.querySelector(`[data-index="${currentQuestion.seikai}"]`).classList.add('correct');
        }

        setTimeout(() => {
          currentQuestionIndex++;
          displayQuestion();
        }, 2000);
      }
    </script>
  </body>
</html>
